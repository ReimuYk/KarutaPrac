<!DOCTYPE html>
<html lang="zh-cn">

<head>
    <meta charset="UTF-8">
    <title>东方角色主题曲随机播放器</title>
    <meta name="description" content="东方角色主题曲随机播放器">
    <style type="text/css">
        table {
            font-family: verdana, arial, sans-serif;
            font-size: 15px;
            color: #333333;
            border-width: 1px;
            border-color: #a9c6c9;
            border-collapse: collapse;
            margin: auto;
        }

        a {
            font-size: 24px;
        }

        th,
        td {
            border: solid 1px #6D6D6D;
            padding: 5px 10px;
        }

        .mt-sm {
            margin-top: 8px;
        }

        body {
            background: #f4f4f4;
            padding: 0;
            margin: 0;
        }

        .container {
            /* width: 1024px; */
            margin: 0 auto;
            background: #fff;
            padding: 20px;
            min-height: 100vh;
            text-align: center;
        }

        #answer {
            text-align: center;
        }

        button {
            font-size: 20px;
        }

        .battle_pic {
            width: 100px;
        }

        .battle_pic_ai {
            -webkit-transform:rotate(180deg);
        }
    </style>
    <script type="text/javascript" src="https://hieda-no-tzz.github.io/TouHou/jquery.min.js"></script>
    <script type="text/javascript" src="https://hieda-no-tzz.github.io/TouHou/xlsx.core.min.js"></script>
</head>

<body>
    <div class="container">
        <h1>东方鸽牌练习器v1.0.4</h1>
        <h2>说明：勾选考纲 -|:随机播放-显示答案:|</h4>
            <!-- <a href="角色曲列表.xlsx" download="角色曲列表.xlsx">下载角色曲列表</a>
            <a href="" id='forDownload' hidden download target="_blank">下载</a> -->
            <!-- <select id="cardfiles" style="width:150px;height:30px;">
                <option value="幻想星颜萃&全Q版の幻想乡共用卡组">幻想星颜萃&全Q版の幻想乡共用卡组</option>
                <option value="幻想星颜萃">幻想星颜萃</option>
                <option value="幻想符式绘">幻想符式绘</option>
                <option value="恋心浮绘录-觉">恋心浮绘录-觉</option>
                <option value="恋心浮绘录-恋">恋心浮绘录-恋</option>
            </select> -->
            <!-- <button onclick="javascript:downloadCardfile()">下载</button>
            <button onclick="javascript:loadRemoteCardfile()">加载</button> -->
            <!-- <br> -->
            <audio controls="controls" src="http://music.163.com/song/media/outer/url?id=22766017" id="player" type="audio/ogg" loop></audio>
            <br>
            <form onclick="changeMode()">
                <input type="radio" name="mode" value="mode1" checked="true">Warm Up Mode
                <input type="radio" name="mode" value="mode2">PVE Mode
            </form>
            <button onclick="javascript:randomSelect()">随机选择</button>
            <button onclick="javascript:answer()">显示答案</button>
            <div id="answer">
                <p id='作品编号'></p>
                <p id='作品名称'></p>
                <p id='BGM中文标题'></p>
                <p id='BGM日文标题'></p>
                <p id='角色'></p>
                <p id='corr_pic'></p>
            </div>
            <!-- <div class="mt-sm">
                <input type="file" id="file" style="display:none;" />
                <input type="file" id="cardfile" style="display:none;" />
                <button onclick="javascript:selectFile()">加载本地角色曲列表</button>
                <button onclick="javascript:loadLocalCardfile()">加载本地卡牌人物列表</button>
                <button onclick="javascript:addRandom()">随机添加10首</button>
                <button onclick="javascript:chooseBGMs()">显示选择</button>
                <button onclick="javascript:displayAll()">全部显示</button>
                <br>
                <p style="font-size:20px" white-space="nowrap">输入角色名进行筛选：
                    <input type="text" name="filter" id="filter" oninput="javascript:filter()"
                        style="width:200px;height:30px;"></p>
            </div> -->
            <div style="-webkit-transform:rotate(180deg);display: none;">
                <td><img id="pic0" onclick="pic_click(this.id)" src="https://reimuyk.github.io/KarutaPrac/img/TH06/cirno.png"></td>
            </div>
            

            <div id="mode1">
                <table id="pic_table">
                    <tr>
                        <td><img id="pic0" onclick="pic_click(this.id)" src="https://reimuyk.github.io/KarutaPrac/img/TH06/cirno.png"></td>
                        <td><img id="pic1" onclick="pic_click(this.id)" src="https://reimuyk.github.io/KarutaPrac/img/TH06/cirno.png"></td>
                        <td><img id="pic2" onclick="pic_click(this.id)" src="https://reimuyk.github.io/KarutaPrac/img/TH06/cirno.png"></td>
                        <td><img id="pic3" onclick="pic_click(this.id)" src="https://reimuyk.github.io/KarutaPrac/img/TH06/cirno.png"></td>
                        <td><img id="pic4" onclick="pic_click(this.id)" src="https://reimuyk.github.io/KarutaPrac/img/TH06/cirno.png"></td>
                        <td><img id="pic5" onclick="pic_click(this.id)" src="https://reimuyk.github.io/KarutaPrac/img/TH06/cirno.png"></td>
                    </tr>
                    <tr>
                        <td><img id="pic6" onclick="pic_click(this.id)" src="https://reimuyk.github.io/KarutaPrac/img/TH06/cirno.png"></td>
                        <td><img id="pic7" onclick="pic_click(this.id)" src="https://reimuyk.github.io/KarutaPrac/img/TH06/cirno.png"></td>
                        <td><img id="pic8" onclick="pic_click(this.id)" src="https://reimuyk.github.io/KarutaPrac/img/TH06/cirno.png"></td>
                        <td><img id="pic9" onclick="pic_click(this.id)" src="https://reimuyk.github.io/KarutaPrac/img/TH06/cirno.png"></td>
                        <td><img id="pic10" onclick="pic_click(this.id)" src="https://reimuyk.github.io/KarutaPrac/img/TH06/cirno.png"></td>
                        <td><img id="pic11" onclick="pic_click(this.id)" src="https://reimuyk.github.io/KarutaPrac/img/TH06/cirno.png"></td>
                    </tr>
                </table>
            </div>

            <div id="mode2" style="display:none;">
                <div id="mode2_table">
                    <table id="battle_table">
                        <tr>
                            <p>this is battle mode</p>
                        </tr>
                    </table>
                </div>
                <button onclick="dealCards()">发牌</button>
                <div id="status">游戏方法：选择考纲（全选即可），点一下发牌按钮，此后每个回合按Go按钮开始（乐曲将自动开始），当你选到对面的牌时，最下方会显示my_move状态，点一下自阵的一张牌交给对方，有bug随时私戳残雪</div>
            </div>

            <div id="result">
                <table id='BGMtable'></table>
            </div>

            <div id="preload" style="display:none;">
                <img src="https://reimuyk.github.io/KarutaPrac/metadata/correct.png">
                <img src="https://reimuyk.github.io/KarutaPrac/metadata/wrong.png">
            </div>
    </div>

    <script type="text/javascript">
        function test() {
        }
        /*
         Global Variables
         */
        var mode_list = ['mode1', 'mode2']
        var mode = 'mode1'

        var player_up_cards = []
        var player_down_cards = []
        var mode2_status = 'prepare' // 'prepare' or 'waiting' or 'battle' or 'move' or 'my_move'
        var bot_latency = 5000 // after ... ms, bot picks a card
        var correct_picture = ''
        var wrong_flag = '' // '' or 'down' or 'up' or 'both'
        var turn = 0
        

        /*
         General Library
         */
        function sleep (time) {
            return new Promise((resolve) => setTimeout(resolve, time));
        }

        function getRandomArrayElements(arr, count) {
            var shuffled = arr.slice(0), i = arr.length, min = i - count, temp, index;
            while (i-- > min) {
                index = Math.floor((i + 1) * Math.random());
                temp = shuffled[index];
                shuffled[index] = shuffled[i];
                shuffled[i] = temp;
            }
            return shuffled.slice(min);
        }

        /*
         Useful Functions
         */
        function changeState(new_state) {
            console.log("state change:" + mode2_status + "->" + new_state)
            mode2_status = new_state
            document.getElementById("status").innerHTML = new_state
        }
        
        function getTableRows() {
            var table = document.getElementById('BGMtable')
            return table.rows
        }

        function getCheckedRows() {
            var checkbox = document.getElementsByClassName('checkbox')
            var rows = getTableRows()
            var bgms = []
            for (i = 1; i < rows.length; ++i) {
                if (checkbox[i].checked && rows[i].style.display != 'none') {
                    bgms.push(i)
                }
            }
            return bgms
        }

        /*
         audio listener
         */
        var audio_f = document.getElementById("player")
        audio_f.addEventListener("play", function () {   //开始播放时触发
            if (mode=="mode2" && mode2_status=="battle") {
                var temp_turn = turn
                sleep(bot_latency).then(() => {
                    if (temp_turn == turn) botPickCards()
                })
            }
        });
        audio_f.addEventListener("canplay", function () {   // 暂停时会触发，当播放完一首歌曲时也会触发
            console.log("event canplay: " + (new Date()).getTime());
        })
        audio_f.addEventListener("pause", function () {   // 暂停时会触发，当播放完一首歌曲时也会触发
            console.log("event pause: " + (new Date()).getTime());
        })
        audio_f.addEventListener("ended",function(){
            // $(".reading_audio_play,.reading_audio_bgBox").removeClass("play")
            console.log("pause---ednded")
            audio_f.pause();
        },false);
        
        /* 
         Page Logics
         */
        function changeMode() {
            mode = $("[name='mode']").filter(":checked").attr("value"); 

            // switch
            document.getElementById(mode).style.display = ''
            for (var i=0; i<mode_list.length; i++) {
                if (mode_list[i] != mode) {
                    document.getElementById(mode_list[i]).style.display = 'none'
                }
            }
            console.log("change mode to :" + mode)

            // mode2 content
            if (mode == "mode2") {
                refreshTablecloth()
            }
            
        }

        /*
         Mode 1
         */
        function pic_click(pic_id) {
            var p_this = document.getElementById(pic_id)
            console.log(pic_id + "is clicked");
            var corr_pic_elem = document.getElementById('corr_pic')
            if (pic_id == 'pic' + corr_pic_elem.innerHTML){
                console.log('right answer')
                p_this.src = "https://reimuyk.github.io/KarutaPrac/metadata/correct.png"
            } else {
                console.log('wrong!!!')
                p_this.src = "https://reimuyk.github.io/KarutaPrac/metadata/wrong.png"
            }
        };

        /*
         Mode 2
         */
        function buttonGo() {
            if (mode2_status != 'waiting' && mode2_status != 'prepare') {
                console.log("buttonGo:" + mode2_status)
                return
            }

            turn += 1
            changeState('battle')

            loadAudio(audio_f, function () {
                var duration = audio_f.duration
                audio_f.currentTime = Math.random() * duration
                audio_f.play()
            })
        }
        function refreshTablecloth() {
            if (mode == 'mode2') {
                var table_content = "<table id='battle_table'>"
                var pic_index = 0
                for (var i=0; i<3; i++) {
                    table_content += '<tr>'
                    for (var j=0; j<8; j++) {
                        table_content += "<td><img id='bpic" + pic_index.toString() + "' onclick='battlePick(this.id)' class='battle_pic battle_pic_ai' src='https://reimuyk.github.io/KarutaPrac/img/TH06/cirno.png'></td>"
                        pic_index += 1
                    }
                    table_content += '</tr>'
                }
                table_content += "<tr>"
                table_content += "<td/>"
                table_content += "<td/>"
                table_content += "<td/>"
                table_content += "<td><button onclick='buttonGo()'>Go!!!</button></td>"
                table_content += "<td/>"
                table_content += "<td/>"
                table_content += "<td/>"
                table_content += "<td/>"
                table_content += "</tr>"

                for (var i=0; i<3; i++) {
                    table_content += '<tr>'
                    for (var j=0; j<8; j++) {
                        table_content += "<td><img id='bpic" + pic_index.toString() + "' onclick='battlePick(this.id)' class='battle_pic' src='https://reimuyk.github.io/KarutaPrac/img/TH06/cirno.png'></td>"
                        pic_index += 1
                    }
                    table_content += '</tr>'
                }
                table_content += "</table>"
                
                document.getElementById('mode2_table').innerHTML = table_content
            }
        }

        function loadAudio(audio, callback) {
            var table = document.getElementById('BGMtable')
            var checkbox = document.getElementsByClassName('checkbox')
            var rows = table.rows
            var bgms = []
            for (i = 1; i < rows.length; ++i) {
                if (checkbox[i].checked && rows[i].style.display != 'none') {
                    bgms.push(i)
                }
            }
            var idx = getRandomArrayElements(bgms, 1)[0]

            rows[idx].style.display = 'none'

            var game_no = document.getElementById('作品编号')
            var game_name = document.getElementById('作品名称')
            var bgm_jpn_title = document.getElementById('BGM中文标题')
            var bgm_chn_title = document.getElementById('BGM日文标题')
            var girl_name = document.getElementById('角色')
            var corr_pic_elem = document.getElementById('corr_pic')

            game_no.hidden = true
            game_name.hidden = true
            bgm_jpn_title.hidden = true
            bgm_chn_title.hidden = true
            girl_name.hidden = true
            corr_pic_elem.hidden = true

            game_no.innerHTML = rows[idx].cells[1].innerHTML
            game_name.innerHTML = rows[idx].cells[2].innerHTML
            bgm_jpn_title.innerHTML = rows[idx].cells[3].innerHTML
            bgm_chn_title.innerHTML = rows[idx].cells[4].innerHTML
            girl_name.innerHTML = rows[idx].cells[5].innerHTML
            

            dirname = '[' + rows[idx].cells[1].innerHTML + '] ' + rows[idx].cells[2].innerHTML
            audio.src = 'http://music.163.com/song/media/outer/url?id=' + rows[idx].cells[6].innerHTML
            audio.load()

            correct_picture = rows[idx].cells[1].innerHTML + '/' + rows[idx].cells[7].innerHTML

            audio.onloadedmetadata = callback
        }

        function botPickCards() {
            console.log("botPickCards " + mode2_status + turn)
            for (var i=0; i<48; i++) {
                var p = document.getElementById('bpic'+i.toString())
                // console.log(p.src)
                // console.log("ref:"+"https://reimuyk.github.io/KarutaPrac/img/" + correct_picture)
                if (p.src == "https://reimuyk.github.io/KarutaPrac/img/" + correct_picture && mode2_status == 'battle') {
                    mode2_status = 'move'
                    console.log("correct: " + i)
                    p.src = "https://reimuyk.github.io/KarutaPrac/metadata/wrong.png"
                    sleep(1000).then(() => {
                        p.src = 'about:blank'
                        console.log("botpic sleep " + i)
                        if (i >= 24) {
                            // move a card downwards
                            console.log("i >= 24")
                            for (var j=0; j<24; j++) {
                                var pm = document.getElementById('bpic'+j.toString())
                                if (pm.src != 'about:blank') {
                                    console.log("pmsrc = "+pm.src)
                                    var temp_src = pm.src
                                    pm.src = 'about:blank'
                                    for (var k=24; k<48; k++) {
                                        var pe = document.getElementById('bpic'+k.toString())
                                        console.log("pesrc = " + pe.src)
                                        if (pe.src == 'about:blank') {
                                            console.log(pe.src)
                                            console.log(temp_src)
                                            pe.src = temp_src
                                            break
                                        }
                                    }
                                    break
                                }
                            }
                        }
                        changeState('waiting')
                        turn += 1
                    })
                    return
                }
            }
            changeState('waiting')
            turn += 1
            console.log("bot_pick: not exists")
        }

        function battlePick(pic_id) {
            var p_i = eval(pic_id.slice(4)) // (int)
            var p = document.getElementById(pic_id)
            console.log("battlePick: p_i=" + p_i)
            console.log("battlePick: pic_id=" + pic_id)

            if (mode2_status == 'my_move') {
                // choice a card to move forward
                if (p_i >=  24 && p.src != 'about:blank') {
                    changeState('waiting')
                    var temp_src = p.src
                    p.src = 'about:blank'
                    for (var i=0; i<24; i++) {
                        var pu = document.getElementById('bpic' + i.toString())
                        if (pu.src == 'about:blank') {
                            pu.src = temp_src
                            break
                        }
                    }
                }
                return
            }
            
            if (mode2_status == 'battle') {
                if (p.src == "https://reimuyk.github.io/KarutaPrac/img/" + correct_picture) {
                    turn += 1
                    changeState('move')
                    p.src = "https://reimuyk.github.io/KarutaPrac/metadata/correct.png"
                    sleep(1000).then(() => {
                        p.src = 'about:blank'
                        
                        if (p_i < 24) {
                            // notice click a picture to move
                            changeState('my_move')
                        } else {
                            changeState('waiting')
                        }
                    })
                } else {
                    // no punish mode

                    // var temp_src = p.src
                    // p.src = "https://reimuyk.github.io/KarutaPrac/metadata/wrong.png"
                }
            }
                
        }

        function assignCards() {
            for (var i=0; i<player_up_cards.length; i++) {
                var p = document.getElementById("bpic" + i.toString())
                p.src = "https://reimuyk.github.io/KarutaPrac/img/" + player_up_cards[i]
            }

            for (var i=0; i<player_down_cards.length; i++) {
                var p = document.getElementById("bpic" + (i + 24).toString())
                p.src = "https://reimuyk.github.io/KarutaPrac/img/" + player_down_cards[i]
            }
        }

        function dealCards() {
            var rows = getTableRows()
            var bgms = getCheckedRows()
            
            var cards = new Set()
            for (var i=0; i<bgms.length; i++) {
                var file_path = rows[bgms[i]].cells[1].innerHTML + '/' + rows[bgms[i]].cells[7].innerHTML
                cards.add(file_path)
            }
            cards = Array.from(cards) // non-dup array
            cards = getRandomArrayElements(cards, 48)
            player_up_cards = cards.slice(0,24)
            player_down_cards = cards.slice(24,48)
            
            console.log("up:" + player_up_cards.length)
            console.log("dow:" + player_down_cards.length)
            console.log(cards)

            assignCards()
        }

        /*
         Load Data Logic
         */
        
        // 自动加载远程excel
        readWorkbookFromRemoteFile('https://reimuyk.github.io/KarutaPrac/zun_list.xlsx', function (workbook) {
            readWorkbook(workbook);
        });
        function readWorkbookFromRemoteFile(url, callback) {
            var xhr = new XMLHttpRequest();
            xhr.open('get', url, true);
            xhr.responseType = 'arraybuffer';
            xhr.onload = function (e) {
                if (xhr.status == 200) {
                    var data = new Uint8Array(xhr.response)
                    var workbook = XLSX.read(data, { type: 'array' });
                    if (callback) callback(workbook);
                }
            };
            xhr.send();
        }
        // 加载本地excel文件
        function selectFile() {
            document.getElementById('file').click();
        }
        $(function () {
            document.getElementById('file').addEventListener('change', function (e) {
                var files = e.target.files;
                if (files.length == 0) return;
                var f = files[0];
                if (!/\.xlsx$/g.test(f.name) && !/\.csv$/g.test(f.name)) {
                    alert('仅支持读取xlsx或csv格式！');
                    return;
                }
                if (/\.xlsx$/g.test(f.name)) {
                    readWorkbookFromLocalFile(f, function (workbook) {
                        readWorkbook(workbook);
                    });
                } else {
                    readCSVFromLocalFile(f, function (workbook) {
                        readCSV(workbook);
                    });
                }
            });
        });
        function readWorkbookFromLocalFile(file, callback) {
            var reader = new FileReader();
            reader.onload = function (e) {
                var data = e.target.result;
                var workbook = XLSX.read(data, { type: 'binary' });
                if (callback) callback(workbook);
            };
            reader.readAsBinaryString(file);
        }
        function readWorkbook(workbook) {
            var sheetNames = workbook.SheetNames; // 工作表名称集合
            var worksheet = workbook.Sheets[sheetNames[0]]; // 这里我们只读取第一张sheet
            var csv = XLSX.utils.sheet_to_csv(worksheet);
            // document.getElementById('result').innerHTML = csv2table(csv);
            modifyTable(csv);
        }
        function readCSVFromLocalFile(file, callback) {
            var reader = new FileReader();
            reader.onload = function (e) {
                var csv = e.target.result;
                if (callback) callback(csv);
            };
            reader.readAsText(file);
        }
        function readCSV(csv) {
            modifyTable(csv);
        }
        function modifyTable(csv) {
            table = document.getElementById('BGMtable');
            var rows = csv.split('\n');
            var content = '';
            rows.pop();
            rows.forEach(function (row, idx) {
                var columns = row.split(',');

                if (idx == 0) columns.unshift('');
                else columns.unshift(idx); // 添加行索引
                content += '<tr>';
                
                columns.forEach(function (column, index) {
                    if (index==0) {
                        content += '<td>' + column + '</button></td>'
                    } else {
                        content += '<td>' + column + '</td>';
                    }
                });
                if (idx != 0) content += '<td><input type="checkbox" class="checkbox" id=' + idx + '></td>';
                else content += '<td><input type="checkbox" class="checkbox" onclick="javascript:checkAll()" id="checkAll" value="全选"></td>'
                content += '</tr>';
            });
            table.innerHTML = content;
        }

        // 加载本地卡牌列表
        function loadLocalCardfile() {
            document.getElementById('cardfile').click();
        }
        const shuffle = ([...arr]) => {
            let m = arr.length;
            while (m) {
                const i = Math.floor(Math.random() * m--);
                [arr[m], arr[i]] = [arr[i], arr[m]];
            }
            return arr;
        };
        $(function () {
            document.getElementById('cardfile').addEventListener('change', function (e) {
                var files = e.target.files;
                for (i = 0; i < files.length; ++i) {
                    var f = files[i]
                    var reader = new FileReader();
                    reader.onload = function () {
                        var cards = this.result.split('\n')
                        loadCards(cards)
                    }
                    reader.readAsText(f);
                }
            })
        })
        function loadCards(cards) {
            var table = document.getElementById('BGMtable')
            var rows = table.rows
            var checkbox = document.getElementsByClassName('checkbox')
            var order = Array.from(Array(rows.length - 1), (v, k) => k + 1);
            order = shuffle(order)
            order.forEach(function (j) {
                var cellname = rows[j].cells[5].innerHTML
                for (k = 0; k < cards.length; ++k) {
                    if (cellname.trim().replace(/&amp;/g,"&") == cards[k].trim()) {
                        checkbox[j].checked = true
                        cards.splice(k, 1)
                        break
                    }
                }
            })
        }
        // 显示选择
        function chooseBGMs() {
            var checkbox = document.getElementsByClassName('checkbox');
            var table = document.getElementById('BGMtable');
            var selected = ''
            for (i = 1; i < checkbox.length; ++i) {
                if (checkbox[i].checked) {
                    table.rows[i].style.display = ''
                } else {
                    table.rows[i].style.display = 'none'
                }
            }
        }
        // 全部显示
        function displayAll() {
            var table = document.getElementById('BGMtable');
            for (i = 1; i < table.rows.length; ++i) {
                table.rows[i].style.display = ''
            }
        }
        // 全选按钮
        function checkAll() {
            var e = document.getElementById('checkAll')
            var checkboxs = document.getElementsByClassName('checkbox');
            var rows = document.getElementById('BGMtable').rows
            for (i = 1; i < checkboxs.length; ++i) {
                if (rows[i].style.display != 'none') { // 只操作当前筛选项
                    checkboxs[i].checked = e.checked
                }
            }
        }
        // 搜索筛选
        function filter() {
            var name = document.getElementById('filter').value
            var table = document.getElementById('BGMtable')
            var rows = table.rows
            for (i = 1; i < rows.length; ++i) {
                var cellname = rows[i].cells[5].innerHTML
                if (cellname.search(name) < 0) {
                    rows[i].style.display = 'none'
                } else {
                    rows[i].style.display = ''
                }
            }
            var e = document.getElementById('checkAll')
            e.checked = false
        }
        // 随机播放
        function randomSelect() {
            // load random audio
            var audio = document.getElementById('player')
            loadAudioAndPics(audio, function () {
                var duration = audio.duration
                audio.currentTime = Math.random() * duration
                console.log("event durationchanged: " + (new Date()).getTime());
            })
        }

        function loadAudioAndPics(audio, callback) {
            var table = document.getElementById('BGMtable')
            var checkbox = document.getElementsByClassName('checkbox')
            var rows = table.rows
            var bgms = []
            for (i = 1; i < rows.length; ++i) {
                if (checkbox[i].checked && rows[i].style.display != 'none') {
                    bgms.push(i)
                }
            }
            var idxs = getRandomArrayElements(bgms, 12)
            var idx = idxs[0]
            idxs = getRandomArrayElements(idxs, 12) // shuffle idxs

            // rows[idx].style.display = 'none'

            var game_no = document.getElementById('作品编号')
            var game_name = document.getElementById('作品名称')
            var bgm_jpn_title = document.getElementById('BGM中文标题')
            var bgm_chn_title = document.getElementById('BGM日文标题')
            var girl_name = document.getElementById('角色')
            var corr_pic_elem = document.getElementById('corr_pic')

            game_no.hidden = true
            game_name.hidden = true
            bgm_jpn_title.hidden = true
            bgm_chn_title.hidden = true
            girl_name.hidden = true
            corr_pic_elem.hidden = true

            game_no.innerHTML = rows[idx].cells[1].innerHTML
            game_name.innerHTML = rows[idx].cells[2].innerHTML
            bgm_jpn_title.innerHTML = rows[idx].cells[3].innerHTML
            bgm_chn_title.innerHTML = rows[idx].cells[4].innerHTML
            girl_name.innerHTML = rows[idx].cells[5].innerHTML
            for (var i=0; i<12; i++) {
                if (idxs[i] == idx)
                    corr_pic_elem.innerHTML = i
            }
            

            dirname = '[' + rows[idx].cells[1].innerHTML + '] ' + rows[idx].cells[2].innerHTML
            // audio.src = 'mp3\\' + dirname + '\\' + rows[idx].cells[4].innerHTML + '.mp3' // 本地播放
            audio.src = 'http://music.163.com/song/media/outer/url?id=' + rows[idx].cells[6].innerHTML
            audio.load()

            // load 12 random pics
            for (var i=0; i<12; i++) {
                var p = document.getElementById('pic'+i.toString())
                p.src = 'about:blank'
                p.src = 'https://reimuyk.github.io/KarutaPrac/img/' + rows[idxs[i]].cells[1].innerHTML + '/' + rows[idxs[i]].cells[7].innerHTML
                
            }

            audio.onloadedmetadata = callback
        }
        // 显示答案
        function answer() {
            var game_no = document.getElementById('作品编号')
            var game_name = document.getElementById('作品名称')
            var bgm_jpn_title = document.getElementById('BGM中文标题')
            var bgm_chn_title = document.getElementById('BGM日文标题')
            var girl_name = document.getElementById('角色')
            var corr_pic_elem = document.getElementById('corr_pic')
            game_no.hidden = false
            game_name.hidden = false
            bgm_jpn_title.hidden = false
            bgm_chn_title.hidden = false
            girl_name.hidden = false
            corr_pic_elem.hidden = false
        }
        // 随机添加10首
        // function addRandom() {
        //     var checkboxs = document.getElementsByClassName('checkbox');
        //     var rows = document.getElementById('BGMtable').rows
        //     var order = Array.from(Array(rows.length - 1), (v, k) => k + 1);
        //     order = shuffle(order)
        //     count = 0
        //     for (i = 0; i < order.length; ++i) {
        //         if (!checkboxs[order[i]].checked) {
        //             checkboxs[order[i]].checked = true
        //             count++
        //             if (count >= 10) {
        //                 break
        //             }
        //         }
        //     }
        // }
        // // 下载远程卡牌列表
        // function downloadCardfile() {
        //     var selected = document.getElementById('cardfiles')
        //     var a = document.getElementById('forDownload')
        //     a.href = 'https://hieda-no-tzz.github.io/TouHou/' + selected.value + '.txt'
        //     a.title = selected.value + '.txt'
        //     a.click()
        // }
        // 加载远程卡牌列表
        // function loadRemoteCardfile() {
        //     var selected = document.getElementById('cardfiles')
        //     var url = 'https://hieda-no-tzz.github.io/TouHou/' + selected.value + '.txt'
        //     var xhr = new XMLHttpRequest();
        //     xhr.open('get', url, true);
        //     xhr.onload = function (e) {
        //         if (xhr.status == 200) {
        //             var cards = xhr.responseText.split('\n')
        //             loadCards(cards)
        //         }
        //     };
        //     xhr.send();
        // }
        // 鼠标移动到按钮上选中复选框
        function check(idx) {
            var checkboxs = document.getElementsByClassName('checkbox');
            checkboxs[idx].checked = !checkboxs[idx].checked;
        }
    </script>
    <script type="text/javascript">
    </script>
</body>

</html>
